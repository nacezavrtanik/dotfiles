#!/bin/bash

invalid_syntax=1
invalid_color=11
message_too_long=12
no_active_tmux_session=21


usage() {
    cat << EOF
Usage: remind [OPTION]... MESSAGE...
Display a popup reminder in the active tmux session.

Options:
  -h, --help           display this help and exit
  -c, --color COLOR    set reminder color; can be red, green, or blue (default)

Exit status:
  0     everything OK,
  1     invalid syntax,
  11    invalid color,
  12    message too long,
  21    no active tmux session.
EOF
}


parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h | --help)
                help=true
                return 0
                ;;
            -c | --color)
                [[ $# -gt 1 ]] || return $invalid_syntax
                color=$2
                shift 2
                ;;
            --)
                shift
                message="$@"
                break
                ;;
            *)
                message="$@"
                break
                ;;
        esac
    done
    [[ -z $message ]] && return $invalid_syntax
    printf -- "${help:=false} ${color:=blue} $message"
}


display_popup() {
    help=$1
    $help && usage && return
    shift

    color=$1
    case $color in
        red)
            style="bg=$color,fg=black"
            ;;
        blue | green)
            style="bg=$color,fg=white"
            ;;
        *)
            echo "ERROR: *$color* is not a valid color ..." >&2
            return $invalid_color
            ;;
    esac
    shift

    message="$@"
    max_length=80
    if [[ ${#message} -gt $max_length ]]; then
        echo "ERROR: Message is longer than $max_length characters ..." >&2
        return $message_too_long
    fi

    width=40; heigth=11
    if [[ $((${#message} + 4)) -gt $width ]]; then
        width=$((${#message} + 4))
    fi
    indent=$((($width - 1 - ${#message}) / 2)); newlines=$((($heigth - 3) / 2))
    popup_body=$(cat << EOF
        tput clear civis; stty -echo
        printf '%.0s\n' $(seq -s ' ' 1 $newlines)
        printf '%*s' $indent ''
        printf "$message"
        read input
EOF
)

    active_session=$(tmux list-sessions | grep '(attached)$' | cut -d ':' -f 1)
    if [[ -z $active_session ]]; then
        echo "ERROR: No active tmux session ..." >&2
        return $no_active_tmux_session
    fi
    tmux display-popup -E -t "$active_session" \
        -T '#[align=centre] REMINDER ' -S $style -s $style \
        -w $width -h $heigth "$popup_body"
}


if args=$(parse_args "$@"); then
    display_popup $args
else
    cat << EOF >&2
Invalid syntax ...
Try 'remind --help' for more information.
EOF
    (exit $invalid_syntax)
fi

