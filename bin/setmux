#!/bin/bash
set -o errexit -o nounset

setup_sessions() {
    if $(tmux ls > /dev/null 2>&1); then
        echo ERROR: tmux server already running!
        return 1
    fi

    here=$(pwd)
    sess_num=0

    shlf --create todo 2> /dev/null || true
    shlf --create workspace 2> /dev/null || true

    s=null
    cd
    tmux new-session -d -s "$s"
    echo "$((sess_num++)): $s"

    s=shlf
    initial="$s"
    cd
    tmux new-session -d -s "$s"
    tmux send-keys -t "$s" 'shlf --open todo' C-m
    echo "$((sess_num++)): $s"

    s=dots
    cd ~/dotfiles
    shlf --create dotfiles 2> /dev/null || true
    tmux new-session -d -s "$s"
    tmux new-window -t "$s"
    tmux new-window -t "$s"
    tmux send-keys -t "$s" 'shlf --open workspace dotfiles' C-m
    echo "$((sess_num++)): $s"

    if [[ -f ~/dotfiles/tmux/sessions.sh ]]; then
        . ~/dotfiles/tmux/sessions.sh "$sess_num"
    fi
    if [[ ! -f ~/dotfiles/tmux/tmux.sessions.conf ]]; then
        cp ~/dotfiles/tmux/tmux.sessions_template.conf ~/dotfiles/tmux/tmux.sessions.conf
    fi

    cd "$here"
    tmux attach-session -t "$initial" \; detach
}


setup_sessions

